<!DOCTYPE html>
<html>
<head><title>S3 Drive</title></head>
<body style="font-family:sans-serif;text-align:center;background:#fff;color:#000;margin:0;padding:20px;">
  <div id="cred">
    <h2>Connect to AWS S3</h2>
    <input id="accessKey" placeholder="Access Key"><br><br>
    <input id="secretKey" placeholder="Secret Key"><br><br>
    <input id="region" placeholder="Region"><br><br>
    <input id="bucket" placeholder="Bucket Name"><br><br>
    <button onclick="saveCreds()">Connect</button>
  </div>

  <div id="home" style="display:none;">
    <h2>S3 Dashboard</h2>
    <p><b>Bucket:</b> <span id="bucketName"></span></p>
    <button onclick="logout()">Disconnect</button>
    <br><br>
    <input type="file" id="uploadFile" multiple><br><br>
    <progress id="progress" value="0" max="100" style="width:50%"></progress><br>
    <button onclick="upload()">Upload</button>
    <hr>
    <div id="fileList" style="display:flex;flex-wrap:wrap;justify-content:center;"></div>
  </div>

  <!-- Full-screen Preview Modal -->
  <div id="previewModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000c;align-items:center;justify-content:center;z-index:999;">
    <img id="previewImg" src="" style="display:none;max-width:90vw;max-height:90vh;border:5px solid #fff;">
    <video id="previewVideo" controls style="display:none;max-width:90vw;max-height:90vh;border:5px solid #fff;"></video>
  </div>

  <script>
    const creds = () => ({
      accessKeyId: localStorage.ak,
      secretAccessKey: localStorage.sk,
      region: localStorage.region,
      bucket: localStorage.bucket
    });

    const api = (path, method, body) =>
      fetch(path, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : null
      }).then(res => res.json());

    const saveCreds = () => {
      localStorage.ak = accessKey.value;
      localStorage.sk = secretKey.value;
      localStorage.region = region.value;
      localStorage.bucket = bucket.value;
      api('/connect', 'POST', creds()).then(res => {
        if (res.success) showHome();
        else alert("Failed to connect: " + res.error);
      });
    };

    const logout = () => {
      localStorage.clear();
      location.reload();
    };

    const showHome = () => {
      cred.style.display = 'none';
      home.style.display = 'block';
      bucketName.innerText = localStorage.bucket;
      loadFiles();
    };

    const upload = () => {
      const files = uploadFile.files;
      if (!files.length) return;
      const uploadFileFn = file => {
        const form = new FormData();
        Object.entries(creds()).forEach(([k,v]) => form.append(k,v));
        form.append('file', file);
        return fetch('/upload', { method: 'POST', body: form });
      };
      [...files].forEach((file, i) => {
        uploadFileFn(file).then(() => {
          progress.value = ((i + 1) / files.length) * 100;
          if (i + 1 === files.length) loadFiles();
        });
      });
    };

    const loadFiles = () => {
      api('/list', 'POST', creds()).then(res => {
        fileList.innerHTML = res.files.map(f => {
          const ext = f.Key.split('.').pop().toLowerCase();
          const src = `/download?ak=${localStorage.ak}&sk=${localStorage.sk}&region=${localStorage.region}&bucket=${localStorage.bucket}&key=${f.Key}`;
          const isImage = ['png','jpg','jpeg','gif','webp'].includes(ext);
          const isVideo = ['mp4','webm','ogg'].includes(ext);

          let preview = `<div style="height:120px"></div>`;
          if (isImage) {
            preview = `<img src="${src}" style="max-width:100%;max-height:120px;cursor:pointer;" onclick="openPreview('${src}', 'img')">`;
          } else if (isVideo) {
            preview = `<video src="${src}" muted style="max-width:100%;max-height:120px;cursor:pointer;" onclick="openPreview('${src}', 'video')"></video>`;
          }

          return `
            <div style="border:1px solid #ccc;margin:10px;padding:10px;width:180px">
              ${preview}<br>
              <small>${f.Key}</small><br>
              <button onclick="download('${f.Key}')">Download</button>
              <button onclick="del('${f.Key}')">Delete</button>
            </div>`;
        }).join('');
      });
    };

    const download = key => {
      const q = new URLSearchParams({ ...creds(), key }).toString();
      window.open(`/download?${q}`);
    };

    const del = key => {
      if (confirm("Delete this file?")) {
        api('/delete', 'POST', { ...creds(), key }).then(loadFiles);
      }
    };

    const openPreview = (src, type) => {
      previewModal.style.display = 'flex';
      if (type === 'img') {
        previewImg.style.display = 'block';
        previewImg.src = src;
        previewVideo.style.display = 'none';
        previewVideo.pause();
      } else if (type === 'video') {
        previewVideo.style.display = 'block';
        previewVideo.src = src;
        previewImg.style.display = 'none';
      }
    };

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        previewModal.style.display = 'none';
        previewImg.src = '';
        previewVideo.pause();
        previewVideo.src = '';
      }
    });

    if (localStorage.ak) showHome();
  </script>
</body>
</html>

